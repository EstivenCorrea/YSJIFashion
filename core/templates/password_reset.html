{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recuperar Contraseña</title>

    <!-- SWEETALERT -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/password_reset.css' %}">
    <link rel="shortcut icon" href="{% static 'images/icon.png' %}">
</head>
<body>

<div class="reset-container">

    {% if modo == "solicitar" %}
        <!-- =======================
            1. SOLICITAR CORREO
        ======================== -->
        <h2 class="reset-title">Recuperar contraseña</h2>
        <p class="reset-description">
            Ingresa tu correo y te enviaremos un enlace para restablecer tu contraseña.
        </p>

        <form id="resetForm">
            {% csrf_token %}
            <input type="email" name="correo" id="email" class="reset-input" placeholder="Correo electrónico" required>
            <button type="submit" class="reset-btn">Enviar enlace</button>
            <a href="{% url 'login' %}" class="reset-back-btn">Volver</a>
        </form>

    {% elif modo == "cambiar" %}
        <!-- =======================
            2. NUEVA CONTRASEÑA
        ======================== -->
        <h2 class="reset-title">Nueva contraseña</h2>
        <p class="reset-description">Crea una nueva contraseña para tu cuenta.</p>

        {% if token_invalido %}
            <p style="color:red;">El enlace es inválido o ha expirado.</p>
            <a href="{% url 'password_reset' %}">Solicitar nuevo enlace</a>
        {% else %}
            <form id="changeForm">
                {% csrf_token %}
                <input type="password" id="password1" class="reset-input" placeholder="Nueva contraseña" required>
                <input type="password" id="password2" class="reset-input" placeholder="Confirmar contraseña" required>
                <button type="submit" class="reset-btn">Guardar</button>
                <a href="{% url 'login' %}" class="reset-back-btn">Volver</a>
            </form>

            <!-- Variables necesarias para JS -->
            <script>
                const urlConfirm = "{% url 'password_reset_confirm' uidb64=uid token=token %}";
            </script>
        {% endif %}
    {% endif %}

</div>

<script>
/* ==============================
   AJAX — ENVIAR CORREO
============================== */
if (document.getElementById("resetForm")) {
    document.getElementById("resetForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const correo = document.getElementById("email").value;

        try {
            const response = await fetch("{% url 'password_reset' %}", {
                method: "POST",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ correo: correo }),
            });

            const result = await response.json();

            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Correo enviado',
                    text: 'Revisa tu bandeja de entrada (o spam).',
                    confirmButtonColor: '#000'
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: result.message,
                    confirmButtonColor: '#000'
                });
            }
        } catch (err) {
            Swal.fire({
                icon: 'error',
                title: 'Error de conexión',
                text: 'No se pudo enviar el correo. Asegúrate de que el servidor esté corriendo.',
                confirmButtonColor: '#000'
            });
        }
    });
}

/* ==============================
   AJAX — GUARDAR NUEVA CONTRASEÑA
============================== */
if (document.getElementById("changeForm") && typeof urlConfirm !== 'undefined') {
    document.getElementById("changeForm").addEventListener("submit", async function(e) {
        e.preventDefault();

        const p1 = document.getElementById("password1").value;
        const p2 = document.getElementById("password2").value;

        if (p1 !== p2) {
            Swal.fire({
                icon: 'error',
                title: 'Las contraseñas no coinciden',
                confirmButtonColor: '#000'
            });
            return;
        }

        try {
            const response = await fetch(urlConfirm, {
                method: "POST",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ nueva: p1, confirmar: p2 }),
            });

            const result = await response.json();

            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Contraseña actualizada',
                    text: 'Ahora puedes iniciar sesión.',
                    confirmButtonColor: '#000'
                }).then(() => window.location.href = "{% url 'login' %}");
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: result.message,
                    confirmButtonColor: '#000'
                });
            }
        } catch (err) {
            Swal.fire({
                icon: 'error',
                title: 'Error de conexión',
                text: 'No se pudo cambiar la contraseña. Asegúrate de que el servidor esté corriendo.',
                confirmButtonColor: '#000'
            });
        }
    });
}
</script>

</body>
</html>
