{% extends 'dashboard_base.html' %}
{% load static %}
{% block content %}
<link href="{% static 'css/AgregarProducto.css' %}" rel="stylesheet" />
<link href="{% static 'css/NotificacionS.css' %}" rel="stylesheet" />


<!-- SweetAlert2: incluye solo una vez en toda la app. Si ya lo incluyes en dashboard_base.html, coméntalo aquí. -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


{% if messages %}
  {% for message in messages %}
    {% if 'dashboard' in message.tags %}
      <script>
        document.addEventListener('DOMContentLoaded', function(){
          try {
            const msgText = "{{ message|escapejs }}";
            const msgLevel = "{{ message.level }}";
            // clave reducida, para evitar keys excesivas (base64 corta)
            const key = 'swal_msg_' + btoa(String(msgLevel) + '||' + msgText).slice(0, 40);
            try {
              const meta = JSON.parse(localStorage.getItem(key) || 'null');
              if (meta && (Date.now() - meta.ts) < 5000) {
                return; // ya mostrado recientemente
              }
            } catch(e){ /* ignore */ }

            Swal.fire({
              icon: "{% if message.level >= 40 %}error{% elif message.level >= 30 %}warning{% elif message.level >= 25 %}success{% else %}info{% endif %}",
              title: msgText,
              showConfirmButton: false,
              timer: 1800
            });

            try {
              localStorage.setItem(key, JSON.stringify({ ts: Date.now() }));
            } catch(e){ /* ignore */ }
          } catch(e) {
            console.warn('swal message show error', e);
          }
        });
      </script>
    {% endif %}
  {% endfor %}
{% endif %}

{% if form and form.non_field_errors %}
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: "{{ form.non_field_errors|join:' ' |escapejs }}",
        showConfirmButton: true
      });
    });
  </script>
{% endif %}

<div class="container" style="position: relative;">
  <h2>Gestión de Productos</h2>
  <div id="stockBell" class="stock-bell" role="button" aria-label="Notificaciones de stock" tabindex="0" title="Productos con stock bajo">
    <svg class="stock-bell-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0 1 18 14.158V11c0-3.07-1.64-5.64-4.5-6.32V4a1.5 1.5 0 0 0-3 0v0.68C7.64 5.36 6 7.93 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"></path>
      <path d="M13.73 21a2 2 0 0 1-3.46 0" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"></path>
    </svg>
    <span id="stockBellCount" class="badge-bell" aria-hidden="true">0</span>
  </div>
  <button class="add-button" onclick="toggleMenu(true)">Agregar +</button>

  <!-- JSON seguro con productos agotados (inyectado desde la vista) -->
  <script id="outOfStockJson" type="application/json">{{ out_of_stock_json|safe }}</script>
  <div class="overlay {% if producto_editar %}show{% endif %}" id="overlay"></div>
  <div class="menu {% if producto_editar %}show{% endif %}" id="addMenu">
  <form id="productForm" method="POST" enctype="multipart/form-data">
      {% csrf_token %} {% if producto_editar %}
      <input
        type="hidden"
        name="producto_id"
        value="{{ producto_editar.id }}"
      />
      {% endif %}
      <div class="split">
        <div class="form-group">
          <label for="{{ form.codigo_producto.id_for_label }}">Código</label>
          {{ form.codigo_producto }}
          <small class="error-message">{% if form.codigo_producto.errors %}{{ form.codigo_producto.errors|striptags }}{% endif %}</small>
        </div>
        <div class="form-group">
          <label for="{{ form.nombre_producto.id_for_label }}">Nombre</label>
          {{ form.nombre_producto }}
          <small class="error-message">{% if form.nombre_producto.errors %}{{ form.nombre_producto.errors|striptags }}{% endif %}</small>
        </div>
      </div>

      <div class="split">
        <div class="form-group">
          <label for="{{ form.descripcion_producto.id_for_label }}">Descripción</label>
          {{ form.descripcion_producto }}
          <small class="error-message">{% if form.descripcion_producto.errors %}{{ form.descripcion_producto.errors|striptags }}{% endif %}</small>
        </div>
      </div>
      <div class="split">
        <div class="form-group">
          <label for="{{ form.valor_producto.id_for_label }}">Valor</label>
          {{ form.valor_producto }}
          <small class="error-message">{% if form.valor_producto.errors %}{{ form.valor_producto.errors|striptags }}{% endif %}</small>
        </div>
        <!-- El campo cantidad fue movido al modelo Stock; se omite del formulario de producto -->
        <div class="form-group">
          <label for="{{ form.categoria.id_for_label }}">Categoría</label>
          {{ form.categoria }}
          <small class="error-message">{% if form.categoria.errors %}{{ form.categoria.errors|striptags }}{% endif %}</small>
        </div>
        <div class="form-group">
          <label for="{{ form.marca.id_for_label }}">Marca</label>
          {{ form.marca }}
          <small class="error-message">{% if form.marca.errors %}{{ form.marca.errors|striptags }}{% endif %}</small>
        </div>
        <div class="form-group">
          <label for="{{ form.proveedor.id_for_label }}">Proveedor</label>
          {{ form.proveedor }}
          <small class="error-message">{% if form.proveedor.errors %}{{ form.proveedor.errors|striptags }}{% endif %}</small>
        </div>
        <div class="form-group">
          <label for="{{ form.descuento.id_for_label }}">Descuento</label>
          {{ form.descuento }}
          <small class="error-message">{% if form.descuento.errors %}{{ form.descuento.errors|striptags }}{% endif %}</small>
        </div>

        <div class="form-group">
          <label for="id_stock_cantidad">Stock</label>
          <input type="number" name="stock_cantidad" id="id_stock_cantidad" min="0" value="{% if form.stock_cantidad.value %}{{ form.stock_cantidad.value }}{% elif producto_editar and producto_editar.stock %}{{ producto_editar.stock.cantidad }}{% else %}0{% endif %}" class="form-control" />
          <small class="error-message">{% if form.stock_cantidad.errors %}{{ form.stock_cantidad.errors|striptags }}{% endif %}</small>
        </div>
      </div>

      <div class="form-group">
        <label for="imagenes"
          >Imágenes del producto (puedes seleccionar varias)</label
        >
        <input type="file" name="imagenes" id="imagenes" multiple />
  <small class="error-message">{% if form.tallas_disponibles.errors %}{{ form.tallas_disponibles.errors|striptags }}{% endif %}</small>
      </div>

      <div class="form-group">
        <label for="{{ form.tallas_disponibles.id_for_label }}"
          >Tallas disponibles (separadas por coma)</label
        >
        {{ form.tallas_disponibles }}
  <small class="error-message">{% if form.colores_disponibles.errors %}{{ form.colores_disponibles.errors|striptags }}{% endif %}</small>
      </div>
      <div class="form-group">
        <label for="{{ form.colores_disponibles.id_for_label }}"
          >Colores disponibles (separados por coma)</label
        >
        {{ form.colores_disponibles }}
        <small class="error-message"></small>
      </div>

      {% if producto_editar and producto_editar.imagen_producto %}
      <div class="form-group">
        <p>Imagen principal actual:</p>
        <img
          src="{{ producto_editar.imagen_producto.url }}"
          alt="Imagen actual"
          width="120"
        />
      </div>
      {% endif %}

      <div class="button-group">
        <button type="submit" class="submit-button">
          {% if producto_editar %}Actualizar{% else %}Guardar{% endif %}
        </button>
        <button type="button" class="cancel-button" onclick="toggleMenu(false)">
          Cancelar
        </button>
      </div>
    </form>
  </div>

  <form
    method="GET"
    action="{% url 'buscar_productos' %}"
    class="form-busqueda-horizontal"
  >
    <input
      type="text"
      name="id_busqueda"
      value="{{ id_busqueda }}"
      placeholder="ID"
      pattern="\d*"
      title="Solo números"
    />
    <input
      type="text"
      name="codigo_busqueda"
      value="{{ codigo_busqueda }}"
      placeholder="Código"
    />
    <input
      type="text"
      name="nombre_busqueda"
      value="{{ nombre_busqueda }}"
      placeholder="Nombre"
    />
    <button type="submit">Buscar</button>
  </form>

  <div class="tarjetas-productos">
    {% for producto in productos %}
    <div class="tarjeta-producto">
      <div class="img-container">
        {% if producto.imagenes.all %}
        <div id="carousel{{ producto.id }}" class="carousel">
          <div class="carousel-inner">
            {% for imagen in producto.imagenes.all %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
              <img
                src="{{ imagen.imagen.url }}"
                alt="{{ producto.nombre_producto }}"
              />
            </div>
            {% endfor %}
          </div>
          {% if producto.imagenes.count > 1 %}
          <!-- Flechas para navegar -->
          <button
            class="carousel-control-prev"
            onclick="moveSlide('{{ producto.id }}', -1)"
          >
            <span class="carousel-control-prev-icon"></span>
          </button>
          <button
            class="carousel-control-next"
            onclick="moveSlide('{{ producto.id }}', 1)"
          >
            <span class="carousel-control-next-icon"></span>
          </button>
          {% endif %}
        </div>
        {% elif producto.imagen_producto %}
        <img
          src="{{ producto.imagen_producto.url }}"
          alt="{{ producto.nombre_producto }}"
        />
        {% else %}
        <div class="img-placeholder">Sin imagen</div>
        {% endif %}
      </div>
      <div class="contenido">
        <h4>{{ producto.nombre_producto }}</h4>
        <p><strong>Código:</strong> {{ producto.codigo_producto }}</p>
        <div class="acciones">
          <a
            href="{% url 'producto_detalle_dashboard' producto.id %}"
            class="btn-ver-mas"
            >Ver más</a
          >
          <a href="{% url 'editar_producto' producto.id %}" class="btn-editar"
            >Editar</a
          >
          <a
            href="{% url 'eliminar_producto' producto.id %}"
            class="btn-eliminar btn btn-danger"
            >Eliminar</a
          >
        </div>
      </div>
    </div>
    {% empty %}
    <p class="mensaje-no-resultados">
      No se encontraron productos con esos criterios.
    </p>
    {% endfor %}
  </div>
</div>

<input
  type="hidden"
  id="mostrarMenu"
  value="{% if producto_editar %}true{% else %}false{% endif %}"
/>

{% if producto_editar %}
  <!-- Valores en inputs ocultos para poblar el formulario si el form no trae valores -->
  <input type="hidden" id="_pe_codigo" value="{{ producto_editar.codigo_producto|default_if_none:''|escapejs }}" />
  <input type="hidden" id="_pe_nombre" value="{{ producto_editar.nombre_producto|default_if_none:''|escapejs }}" />
  <input type="hidden" id="_pe_descripcion" value="{{ producto_editar.descripcion_producto|default_if_none:''|escapejs }}" />
  <input type="hidden" id="_pe_valor" value="{{ producto_editar.valor_producto|default_if_none:'' }}" />
  <input type="hidden" id="_pe_categoria" value="{% if producto_editar.categoria %}{{ producto_editar.categoria.id }}{% else %}{% endif %}" />
  <input type="hidden" id="_pe_marca" value="{% if producto_editar.marca %}{{ producto_editar.marca.id }}{% else %}{% endif %}" />
  <input type="hidden" id="_pe_proveedor" value="{% if producto_editar.proveedor %}{{ producto_editar.proveedor.id }}{% else %}{% endif %}" />
  <input type="hidden" id="_pe_tallas" value="{{ producto_editar.tallas_disponibles|default_if_none:''|escapejs }}" />
  <input type="hidden" id="_pe_colores" value="{{ producto_editar.colores_disponibles|default_if_none:''|escapejs }}" />
  <input type="hidden" id="_pe_stock" value="{% if producto_editar.stock %}{{ producto_editar.stock.cantidad }}{% else %}{% endif %}" />
  <script>
    // Abrir menu cuando la vista devolvió un producto para editar.
    document.addEventListener('DOMContentLoaded', function(){
      try { toggleMenu(true); } catch(e) { /* noop */ }
    });
  </script>
{% endif %}

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("productForm");

    if (!form) return; // seguridad, por si no existe el form en la vista

    // Prefill logic (si model form no logró poblar)
    try {
      const hid = (id) => document.getElementById(id);
      const prefills = [
        {name: 'codigo_producto', hid: '_pe_codigo'},
        {name: 'nombre_producto', hid: '_pe_nombre'},
        {name: 'descripcion_producto', hid: '_pe_descripcion'},
        {name: 'valor_producto', hid: '_pe_valor'},
        {name: 'tallas_disponibles', hid: '_pe_tallas'},
        {name: 'colores_disponibles', hid: '_pe_colores'},
      ];
      prefills.forEach(p => {
        const el = form.querySelector('[name="' + p.name + '"]');
        const h = hid(p.hid);
        if (el && h && (!el.value || el.value === '')) {
          el.value = h.value || '';
        }
      });
      // selects
      const hcat = hid('_pe_categoria');
      if (hcat) {
        const sel = form.querySelector('[name="categoria"]');
        if (sel && (!sel.value || sel.value === '')) sel.value = hcat.value || '';
      }
      const hmarca = hid('_pe_marca');
      if (hmarca) {
        const sel = form.querySelector('[name="marca"]');
        if (sel && (!sel.value || sel.value === '')) sel.value = hmarca.value || '';
      }
      const hprov = hid('_pe_proveedor');
      if (hprov) {
        const sel = form.querySelector('[name="proveedor"]');
        if (sel && (!sel.value || sel.value === '')) sel.value = hprov.value || '';
      }
      // stock
      const hstock = hid('_pe_stock');
      const stockEl = form.querySelector('[name="stock_cantidad"]') || document.getElementById('id_stock_cantidad');
      if (stockEl && hstock && (!stockEl.value || stockEl.value === '')) stockEl.value = hstock.value || 0;
    } catch (e) {
      console.warn('Error al prefijar campos desde inputs ocultos', e);
    }

    // Campos con sus mensajes de error (igual que antes)
    const campos = {
      codigo: {
        input: form.querySelector('[name="codigo_producto"]'),
        errorElem: null,
        validar() {
          const val = this.input.value;
          if (!val) return "El código es obligatorio.";
          if (!/^\d+$/.test(val))
            return "El código debe ser solo números, sin espacios ni letras.";
          return "";
        },
      },
      nombre: {
        input: form.querySelector('[name="nombre_producto"]'),
        errorElem: null,
        validar() {
          const val = this.input.value.trim();
          if (val.length < 4)
            return "El nombre debe tener al menos 4 caracteres.";
          const letras = val.match(/[a-zA-ZáéíóúÁÉÍÓÚñÑ]/g) || [];
          if (letras.length < 4)
            return "El nombre debe tener al menos 4 letras.";
          return "";
        },
      },
      descripcion: {
        input: form.querySelector('[name="descripcion_producto"]'),
        errorElem: null,
        validar() {
          const val = this.input.value.trim();
          if (val.length < 10)
            return "La descripción debe tener al menos 10 caracteres.";
          return "";
        },
      },
      valor: {
        input: form.querySelector('[name="valor_producto"]'),
        errorElem: null,
        validar() {
          const val = parseFloat(this.input.value);
          if (isNaN(val) || val <= 0)
            return "El valor debe ser un número positivo.";
          return "";
        },
      },
      cantidad: {
        input: form.querySelector('[name="cantidad_producto"]'),
        errorElem: null,
        validar() {
          if (!this.input) return "";
          const val = parseInt(this.input.value);
          if (isNaN(val) || val <= 0)
            return "La cantidad debe ser un número entero positivo.";
          return "";
        },
      },
      categoria: {
        input: form.querySelector('[name="categoria"]'),
        errorElem: null,
        validar() {
          if (!this.input.value)
            return "Debes seleccionar una categoría.";
          return "";
        },
      },
      marca: {
        input: form.querySelector('[name="marca"]'),
        errorElem: null,
        validar() {
          if (!this.input.value || this.input.value === "default")
            return "Debes seleccionar una marca.";
          return "";
        },
      },
          descuento: {
        input: form.querySelector('[name="descuento"]'),
        errorElem: null,
        validar() {
          return ""; 
        },
      },
      proveedor: {
        input: form.querySelector('[name="proveedor"]'),
        errorElem: null,
        validar() {
          if (!this.input.value || this.input.value === "default")
            return "Debes seleccionar un proveedor.";
          return "";
        },
      },
      stock: {
        input: form.querySelector('[name="stock_cantidad"]') || document.getElementById('id_stock_cantidad'),
        errorElem: null,
        validar() {
          if (!this.input) return "";
          const val = parseInt(this.input.value);
          if (isNaN(val) || val < 0) return "El stock debe ser 0 o mayor.";
          return "";
        },
      },
     tallas: {
    input: form.querySelector('[name="tallas_disponibles"]'),
    errorElem: null,
    validar() {
      const val = this.input.value;
      if (!val.trim()) return "Las tallas no pueden estar vacías.";
      if (/^\s|\s$/.test(val))
        return "Las tallas no pueden tener espacios al inicio o final.";
      if (!/^([a-zA-Z0-9]+(\s*,\s*[a-zA-Z0-9]+)*)$/.test(val))
        return "Las tallas solo pueden contener letras, números, comas y espacios intermedios.";
      return "";
    },
  },

colores: {
  input: form.querySelector('[name="colores_disponibles"]'),
  errorElem: null,
  validar() {
    const val = this.input.value;
    if (!val.trim()) return "Los colores no pueden estar vacíos.";
    if (/^\s|\s$/.test(val))
      return "Los colores no pueden tener espacios al inicio o final.";
    if (!/^([a-zA-ZáéíóúÁÉÍÓÚñÑ]+(\s[a-zA-ZáéíóúÁÉÍÓÚñÑ]+)*(\s*,\s*[a-zA-ZáéíóúÁÉÍÓÚñÑ]+(\s[a-zA-ZáéíóúÁÉÍÓÚñÑ]+)*)*)$/.test(val))
      return "Los colores solo pueden contener letras, espacios dentro del nombre y comas intermedias.";
    return "";
  },
},

    };

    // Asociar <small> de errores
    for (const key in campos) {
      const input = campos[key].input;
      if (!input) {
        campos[key].errorElem = null;
        continue;
      }
      const parent = input.parentElement || input.closest('.form-group');
      campos[key].errorElem = parent ? parent.querySelector(".error-message") : null;
    }

    // Validar un campo individual
    function validarCampo(campo) {
      try {
        const errorMsg = campo.validar();
        const hasErrorElem = !!campo.errorElem;
        const hasInput = !!campo.input;
        if (errorMsg) {
          if (hasErrorElem) {
            campo.errorElem.textContent = errorMsg;
            campo.errorElem.style.display = "block";
          }
          if (hasInput && campo.input.classList) campo.input.classList.add("input-error");
          return false;
        } else {
          if (hasErrorElem) {
            campo.errorElem.textContent = "";
            campo.errorElem.style.display = "none";
          }
          if (hasInput && campo.input.classList) campo.input.classList.remove("input-error");
          return true;
        }
      } catch (e) {
        console.warn('validarCampo error', e);
        return false;
      }
    }

    // Validación en tiempo real (excepto código que va con AJAX)
    for (const key in campos) {
      if (key === "codigo") continue;
      const campo = campos[key];
      if (!campo.input) continue;
      campo.input.addEventListener("input", () => validarCampo(campo));
      if (campo.input.tagName === "SELECT") {
        campo.input.addEventListener("change", () => validarCampo(campo));
      }
    }

    // Validación AJAX para el código
    const codigoInput = campos.codigo.input;
    const codigoCampo = campos.codigo;
    let codigoTimeout = null;

    codigoInput.addEventListener("input", () => {
      const baseError = codigoCampo.validar();
      if (baseError) {
        codigoCampo.errorElem.textContent = baseError;
        codigoCampo.errorElem.style.display = "block";
        codigoCampo.input.classList.add("input-error");
        return;
      } else {
        codigoCampo.errorElem.textContent = "";
        codigoCampo.errorElem.style.display = "none";
        codigoCampo.input.classList.remove("input-error");
      }

      clearTimeout(codigoTimeout);
      codigoTimeout = setTimeout(() => {
        fetch(
          `/validar-codigo/?codigo=${encodeURIComponent(codigoInput.value)}`
        )
          .then((response) => response.json())
          .then((data) => {
            if (data.existe) {
              codigoCampo.errorElem.textContent = "Este código ya está en uso.";
              codigoCampo.errorElem.style.display = "block";
              codigoCampo.input.classList.add("input-error");
            } else {
              codigoCampo.errorElem.textContent = "";
              codigoCampo.errorElem.style.display = "none";
              codigoCampo.input.classList.remove("input-error");
            }
          })
          .catch(() => {
            codigoCampo.errorElem.textContent = "";
            codigoCampo.errorElem.style.display = "none";
            codigoCampo.input.classList.remove("input-error");
          });
      }, 500);
    });

    // Mostrar nombres de imágenes seleccionadas
    const imagenesInput = document.getElementById("imagenes");
    if (imagenesInput) {
      imagenesInput.addEventListener("change", () => {
        const files = Array.from(imagenesInput.files);
        if (files.length) {
          const nombres = files.map((f) => f.name).join(", ");
          Swal.fire({
            icon: "info",
            title: "Imágenes seleccionadas",
            text: nombres,
            timer: 3000,
            showConfirmButton: false,
          });
        }
      });
    }

    // ----------------------------
    // Submit del formulario (nuevo comportamiento)
    // ----------------------------
    if (!window.__agregarProductoInit) {
      window.__agregarProductoInit = true;

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        // Validaciones
        let todoValido = true;
        for (const key in campos) {
          const campo = campos[key];
          const valido = validarCampo(campo);
          if (!valido) todoValido = false;
        }
        if (campos.codigo.errorElem && campos.codigo.errorElem.style.display === "block") {
          todoValido = false;
        }

        if (!todoValido) {
          Swal.fire({
            icon: "error",
            title: "Formulario inválido",
            text: "Por favor corrige los campos resaltados en rojo.",
          });
          return;
        }

        // Evita doble envío
        if (form.dataset.submitted === '1') {
          return;
        }
        form.dataset.submitted = '1';

        // Mostrar loader (no "éxito" cliente).
        try {
          Swal.fire({
            title: 'Enviando...',
            html: 'Por favor espera mientras guardamos el producto.',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            },
            showConfirmButton: false,
            allowEscapeKey: false
          });
        } catch (e) {
          console.warn('Swal loader fallo', e);
        }

        // Envío normal (POST -> servidor hará redirect y mostrará su propio message)
        form.submit();
      });
    }

    // Mostrar el menú si se está editando
    if (document.getElementById("mostrarMenu").value === "true") {
      toggleMenu(true);
    }
  });

  // Función para abrir/cerrar el menú
  function toggleMenu(show) {
    const overlay = document.getElementById("overlay");
    const menu = document.getElementById("addMenu");
    if (show) {
      overlay.classList.add("show");
      menu.classList.add("show");
    } else {
      overlay.classList.remove("show");
      menu.classList.remove("show");
    }
  }

  // ==========================
  // Eliminar producto (usa SweetAlert confirm)
  // ==========================
  const botonesEliminar = document.querySelectorAll(".btn-eliminar");
  botonesEliminar.forEach((btn) => {
    btn.addEventListener("click", function (e) {
      e.preventDefault();

      const url = this.getAttribute("href"); // la URL de eliminación

      Swal.fire({
        title: "¿Estás seguro?",
        text: "No podrás revertir esta acción",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#6c757d",
        confirmButtonText: "Sí, eliminar",
        cancelButtonText: "Cancelar",
      }).then((result) => {
        if (result.isConfirmed) {
          // Mostrar un loader breve y redirigir al endpoint de eliminación.
          // Evitamos mostrar un mensaje de 'éxito' aquí para no duplicarlo
          // con el mensaje que el servidor añade tras el redirect.
          try {
            Swal.fire({
              title: 'Eliminando...',
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              },
              showConfirmButton: false,
            });
          } catch (e) {
            console.warn('Swal loader fallo', e);
          }

          // Redirige a la URL de eliminación (el servidor suele añadir un message y
          // la página resultante mostrará la confirmación). No esperar al timer
          // del Swal para evitar duplicidad.
          window.location.href = url;
        }
      });
    });
  });

  // Carrusel
  function moveSlide(productId, direction) {
    const carousel = document.querySelector(`#carousel${productId}`);
    if (!carousel) return;
    const items = carousel.querySelectorAll(".carousel-item");
    if (!items || items.length === 0) return;
    let activeIndex = Array.from(items).findIndex((item) =>
      item.classList.contains("active")
    );
    if (activeIndex === -1) activeIndex = 0;

    items[activeIndex].classList.remove("active");

    let nextIndex = activeIndex + direction;
    if (nextIndex < 0) nextIndex = items.length - 1;
    if (nextIndex >= items.length) nextIndex = 0;

    items[nextIndex].classList.add("active");
  }
</script>
<script>
   // Notificaciones de productos agotados — lee JSON seguro inyectado por json_script
  (function () {
    // Config
    const THRESHOLD_RATIO = 0.2; // 20%
    const reviewedKey = "stock_reviewed_ids";

    const toNum = (v) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    };

    // Render / calculadora de notificaciones a partir de un array de productos
    function computeAndRender(outOfStock) {
      const bell = document.getElementById("stockBell");
      const bellCount = document.getElementById("stockBellCount");
      if (!bell || !bellCount) return;

      let reviewed = [];
      try {
        reviewed = JSON.parse(localStorage.getItem(reviewedKey) || "[]");
      } catch (e) {
        reviewed = [];
      }

      // Filtrar solo no revisados y calcular porcentaje/minimo
      const lowStock = outOfStock
        .map((p) => {
          const actual = toNum(
            p.stock_actual ?? p.stock ?? p.cantidad ?? p.qty ?? 0
          );
          const original = toNum(
            p.stock_original ?? p.stock_inicial ?? p.initial_stock ?? 0
          );
          const usedOriginal = original > 0 ? original : null;
          const min = usedOriginal
            ? Math.max(0, Math.ceil(usedOriginal * THRESHOLD_RATIO))
            : null;
          const pct = usedOriginal
            ? Math.round((actual / usedOriginal) * 100)
            : null;
          return Object.assign({}, p, {
            actual,
            original: usedOriginal,
            min,
            pct,
          });
        })
        .filter((p) => {
          if (!p || !p.id) return false;
          if (reviewed.includes(p.id)) return false;
          // Notificar si actual <= min (si min definido) o si pct <= 20%
          if (p.min !== null) return p.actual <= p.min;
          // fallback: notificar si unidades muy bajas (no ideal)
          return p.actual <= 5;
        });

      // Mostrar contador
      if (lowStock.length > 0) {
        bellCount.style.display = "inline-flex";
        bellCount.textContent = String(lowStock.length);
        bell.classList.add("has-notifications");
        bell.setAttribute(
          "aria-label",
          `Hay ${lowStock.length} productos con stock bajo`
        );
        bell.title = `Hay ${lowStock.length} productos con stock bajo`;
      } else {
        bellCount.style.display = "none";
        bell.classList.remove("has-notifications");
        bell.setAttribute("aria-label", "No hay notificaciones de stock");
        bell.title = "No hay notificaciones de stock";
      }

      // Al hacer click mostrar modal con detalle
      bell.onclick = () => {
        if (lowStock.length === 0) {
          Swal.fire(
            "Sin novedades",
            "No hay productos con stock bajo.",
            "info"
          );
          return;
        }

        const lines = lowStock
          .map((p) => {
            const name = p.nombre || p.nombre_producto || p.name || "Producto";
            if (p.original !== null) {
              return `<li style="margin-bottom:10px;"><strong>${name}</strong> — ${p.pct}% (${p.actual} unidades restantes)</li>`;
            } else {
              return `<li style="margin-bottom:10px;"><strong>${name}</strong> — ${p.actual} unidades restantes</li>`;
            }
          })
          .join("");

        Swal.fire({
          title: `Productos con stock bajo (${lowStock.length})`,
          html: `<div style="text-align:left; max-height:320px; overflow:auto;"><ul style="padding-left:1rem;margin:0;">${lines}</ul></div>`,
          width: 700,
          showCancelButton: true,
          confirmButtonText: "Marcar como revisado",
          cancelButtonText: "Cerrar",
        }).then((result) => {
          if (result.isConfirmed) {
            const ids = Array.from(
              new Set((reviewed || []).concat(lowStock.map((i) => i.id)))
            );
            try {
              localStorage.setItem(reviewedKey, JSON.stringify(ids));
            } catch (e) {
              /* noop */
            }
            bellCount.style.display = "none";
            bell.classList.remove("has-notifications");
            Swal.fire({
              icon: "success",
              title: "Marcados",
              text: "Los productos han sido marcados como revisados.",
            });
          }
        });
      };
    }

    // --- Método 1: leer JSON inyectado en la página (ya lo tienes) ---
    function initFromInjectedJson() {
      try {
        const el = document.getElementById("outOfStockJson");
        const arr = el ? JSON.parse(el.textContent || "[]") : [];
        computeAndRender(arr);
      } catch (e) {
        console.warn("Error leyendo outOfStockJson:", e);
      }
    }

    // --- Método 2 (recomendado para ver cambios sin recargar): polling a una API que devuelva JSON actualizado ---
    // Para usarlo, primero crea la vista `out_of_stock_api` (te paso el snippet más abajo) y descomenta la llamada a startPolling()
    let pollingIntervalId = null;
    async function fetchAndUpdateApi() {
      try {
        const resp = await fetch("/api/out-of-stock/"); // ajusta ruta si la cambias
        if (!resp.ok) return;
        const data = await resp.json();
        // Actualiza elemento inyectado (opcional)
        const el = document.getElementById("outOfStockJson");
        if (el) el.textContent = JSON.stringify(data);
        computeAndRender(data);
      } catch (e) {
        console.warn("fetch out_of_stock error", e);
      }
    }
    function startPolling(intervalMs = 30000) {
      fetchAndUpdateApi(); // primera llamada inmediata
      if (pollingIntervalId) clearInterval(pollingIntervalId);
      pollingIntervalId = setInterval(fetchAndUpdateApi, intervalMs);
    }

    // Inicializa desde el JSON inyectado
    document.addEventListener("DOMContentLoaded", () => {
      initFromInjectedJson();
      // Si quieres polling automático para ver compras sin recargar, descomenta la siguiente línea:
      // startPolling(15000); // cada 15s
    });

    // Exponer funciones en window (opcional, para debugging)
    window.__stockNotify = {
      computeAndRender,
      fetchAndUpdateApi,
      startPolling,
    };
  })();
</script>
{% endblock %}
